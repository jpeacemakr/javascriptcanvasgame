<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

        <style>
            body {
                text-align:center;
                background-image: url('images/waves.svg');
            }
            canvas {
                border:0px solid #d3d3d3;
                background-color: #f1f1f1;
            }
            .center {
                width:600px;
                margin:auto;
            }
            div {
                text-align:left;
            }
            * {
                box-sizing:border-box;
            }
        </style>


        <script>

            ///////////////////////////////////
            // about
            // by James Peacemaker
            // the game is made up of a matrix of squares like a checkerboard
            // the game piece can move from one game square to another


            ////////////////////////////////////
            // game variables
            var gameSquareSize = 20; // size of the game piece and game squares
            var gameSquareNumber = 30; // number of game squares
            var gameTotalArea = 600; // total area of the game board (should be gameSquareSize * gameSquareNumber)
            var gamePieceColor = "#BBDDFF";
            var gridColor = "#6699CC";
            var backgroundColor1 = "#99CCFF"; // inside of radial blend
            var backgroundColor2 = "#6699CC"; // outside of radial blend
            var targetNumber = 3;
            var victimNumber = 5;


            ///////////////////////////////
            // represents each square on the board
            // number 1-5 corresponds to distance from target or victim. 0 for target. 9 for victim. 6-8 reserved for future.
            class GameSquare {
                // let mySquare = new GameSquare();
                constructor() {
                    this.hidden = true;
                    this.value = 5;
                }
                reveal() {
                    this.hidden = false;
                }
            }

            /////////////////////////////////        
            // start the game. called from body onload()
            function startGame() {
                myGameArea.start(gameTotalArea, gameTotalArea);
                myTargets.start();
                myGameArea.render();
                myScore.start();
            }

            //////////////////////////////
            // object to control the board
            var myGameArea = {
                // grid of game piece positions
                gameMatrix: new Array (gameSquareNumber),
                
                // canvas to draw into
                canvas : document.createElement("canvas"),
                
                // initializes the values of the game board then calls function to initialize game piece
                start : function(width, height) {
                    this.canvas.width = width;
                    this.canvas.height = height;
                    this.context = this.canvas.getContext("2d");
                    document.getElementById("canvasDiv").appendChild(this.canvas);
                    
                    this.canvas.addEventListener("mousedown", doMouseDown, false);

                    // turn array into square array of arrays
                    for(let i=0; i<gameSquareNumber; i++){
                        this.gameMatrix[i] = new Array (gameSquareNumber);
                    }

                    // initialize the game squares
                    for(let i=0; i<gameSquareNumber; i++){
                        for(let j=0; j<gameSquareNumber; j++){
                            this.gameMatrix[i][j] = new GameSquare();
                        }
                    }
                    // console.log("Debug: " + this.gameMatrix[3][4].value);

                    //initialize game piece
                    myGamePiece.start(15,14,gameSquareSize,gameSquareSize, gamePieceColor);               
                },

                // render the board                
                render : function() {
                    // console.log("Debug: rendering myGameArea");
                    // clear the canvas
                    //this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);

                    // Create gradient
                    var bgGradient = this.context.createRadialGradient(300, 300, 5, 300, 300, 500);
                    bgGradient.addColorStop(0, backgroundColor1);
                    bgGradient.addColorStop(1, backgroundColor2);

                    // Fill with gradient
                    this.context.fillStyle = bgGradient;
                    this.context.fillRect(0, 0, this.canvas.width, this.canvas.height);

                    // redraw the player
                    myGamePiece.render();

                    // redraw the board
                    // set grid style
                    this.context.lineWidth = 1;
                    this.context.strokeStyle = gridColor; 
                    
                    // draw grid horizontal lines
                    for (var i=1; i < gameSquareNumber; i++) {
                        this.context.moveTo(0, i*gameSquareSize);
                        this.context.lineTo(this.canvas.width, i*gameSquareSize);
                        this.context.stroke();
                    }
                    // draw grid vertical lines
                    for (var i=1; i < gameSquareNumber; i++) {
                        this.context.moveTo(i*gameSquareSize, 0);
                        this.context.lineTo(i*gameSquareSize, this.canvas.height);
                        this.context.stroke();
                    }

                    // draw board values
                    this.context.font = '10pt Helvetica';
                    this.context.fillStyle = "#000000";
                    for (var i=0; i < gameSquareNumber; i++) {
                        for (var j=0; j < gameSquareNumber; j++) {
                            if (this.gameMatrix[i][j].hidden == false){
                                this.context.fillText(this.gameMatrix[i][j].value, i*gameSquareSize+6, j*gameSquareSize+16);
                            }
                        }
                    }

                    
                },


                // reset the game board and player
                reveal : function() {
                    // draw board values
                    this.context.font = '10pt Helvetica';
                    this.context.fillStyle = "#000000";
                    for (var i=0; i < gameSquareNumber; i++) {
                        for (var j=0; j < gameSquareNumber; j++) {
                            this.context.fillText(this.gameMatrix[i][j].value, i*gameSquareSize+6, j*gameSquareSize+16);
                        }
                    }
                },

                // reset the game board and player
                clear : function() {
                    this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    myGamePiece.clear();
                    this.render();
                }
            }



            ///////////////////////////////////
            // object to control the player's game piece
            var myGamePiece = {
                // default position, size and color
                x : 0,
                y : 0,
                width : gameSquareSize,
                height: gameSquareSize,
                color : "red",
                context: myGameArea.context,

                // set game piece at start                
                start : function(x, y, width, height, color) {
                    this.x = x*gameSquareSize;
                    this.y = y*gameSquareSize;
                    this.width = width;
                    this.height = height;
                    this.color = color;
                    this.context = myGameArea.context;
                    this.context.fillStyle = this.color;
                    this.context.fillRect(this.x, this.y, this.width, this.height);
                },

                // render the player again                
                render : function() {
                    // console.log("Debug: rendering myGamePiece");
                    //this.context.fillStyle = this.color;
                    //this.context.fillRect(this.x, this.y, this.width, this.height);

                    const imgCrosshair = new Image();        
                    imgCrosshair.src = './images/crosshair.svg';        
                    imgCrosshair.onload = () => {          
                        myGameArea.context.drawImage(imgCrosshair, this.x-80, this.y-80);        
                    };
                },

                // movement functions
                moveRight : function() {
                    if (this.x+gameSquareSize<myGameArea.canvas.width){
                        this.x= this.x + gameSquareSize;
                        myGameArea.render();
                    }
                },
                moveLeft : function() {
                    if (this.x>0){
                        this.x= this.x - gameSquareSize;
                        myGameArea.render();
                    }
                },
                moveUp : function() {
                    if (this.y>0){
                        this.y= this.y - gameSquareSize;
                        myGameArea.render();
                    }
                },
                moveDown : function() {
                    if (this.y+gameSquareSize<myGameArea.canvas.height){
                        this.y= this.y + gameSquareSize;
                        myGameArea.render();
                    }
                },

                // this is the bomb function. it reveals the spot on the map where the gamePiece is located
                reveal : function() {
                    myGameArea.gameMatrix[this.x/gameSquareSize][this.y/gameSquareSize].hidden = 0;
                    myGameArea.render();
                    playBombAudio();
                    bombImage();
                    if (myGameArea.gameMatrix[this.x/gameSquareSize][this.y/gameSquareSize].value == 0) {
                        myScore.update(1000);
                    } else if (myGameArea.gameMatrix[this.x/gameSquareSize][this.y/gameSquareSize].value == 9) {
                        myScore.update(-100);
                    } 
                    else {
                        myScore.update(-10);
                    }
                },
                
                // reset the player to starting position
                clear : function() {
                    this.x = 0;
                    this.y = 0;
                }
            }



            ///////////////////////////////////
            // object to control the targets
            var myTargets = {
                start : function() {
                    this.setTarget();
                    this.setVictims();
                },
                // render the targets and set the distance in the matrix               
                setTarget : function() {

                    // pick random tile for a target
                    // from 0 to gameSquareNumber-1 (0-29)
                    var foundTargets = 0;
                    while (foundTargets < targetNumber) {
                        var targetX = Math.floor(Math.random() * gameSquareNumber);
                        var targetY = Math.floor(Math.random() * gameSquareNumber); 
                        // if target square is used, pick a new target
                        if (myGameArea.gameMatrix[targetX][targetY].value != 0){
                            myGameArea.gameMatrix[targetX][targetY].value = 0;
                            foundTargets++;
                            // console.log("Debug: target position: " + (targetX+1) + " " + (targetY+1));
                            
                            // set distance values in the gameMaxtrix
                            //get area to be manipulated
                            var minX = targetX-4;
                            var maxX = targetX+4;
                            // console.log("Debug: X range to expand: " + minX + " " + maxX);

                            var minY = targetY-4;
                            var maxY = targetY+4;
                            // console.log("Debug: Y range to expand: " + minY + " " + maxY);
                        
                            // make oncentric passes to set distance from target
                            for (var pass = 1; pass < 5; pass++){
                                for (var i = minX; i <= maxX; i++){
                                    for (var j = minY; j <= maxY; j++){
                                        // console.log("Debug: expanding area: " + i + " " + j);
                                        if ((i >=0 && i < gameSquareNumber) && (j >=0 && j < gameSquareNumber) && (myGameArea.gameMatrix[i][j].value <= 5)){
                                            myGameArea.gameMatrix[i][j].value = Math.min(myGameArea.gameMatrix[i][j].value, 5-pass);
                                        }
                                    }
                                }
                                minX++;
                                maxX--;
                                minY++;
                                maxY--;
                            }
                        }
                    }
                
                // render the victims (innocent bystanders) and set distance in the matrix
                }, setVictims : function() {
                    // pick random tiles for victims
                    // from 0 to gameSquareNumber-1 (0-29)
                    // if target square is used, pick a new target
                    var foundVictims = 0;
                    while (foundVictims < victimNumber) {
                        var targetX = Math.floor(Math.random() * gameSquareNumber);
                        var targetY = Math.floor(Math.random() * gameSquareNumber); 
                        // if victim square is used, pick a new victim
                        if ((myGameArea.gameMatrix[targetX][targetY].value != 0) && (myGameArea.gameMatrix[targetX][targetY].value != 9)){
                            myGameArea.gameMatrix[targetX][targetY].value = 9;
                            foundVictims++;
                            // console.log("Debug: victim position: " + (targetX+1) + " " + (targetY+1));
                        
                            // set distance values
                            //get area to be manipulated
                            var minX = targetX-4;
                            var maxX = targetX+4;
                            // console.log("Debug: X range to expand: " + minX + " " + maxX);

                            var minY = targetY-4;
                            var maxY = targetY+4;
                            // console.log("Debug: Y range to expand: " + minY + " " + maxY);

                            // make oncentric passes to set distance from target
                            for (var pass = 1; pass < 5; pass++){
                                for (var i = minX; i <= maxX; i++){
                                    for (var j = minY; j <= maxY; j++){
                                        // console.log("Debug: expanding area: " + i + " " + j);
                                        if ((i >=0 && i < gameSquareNumber) && (j >=0 && j < gameSquareNumber) && (myGameArea.gameMatrix[i][j].value <= 5)){
                                            myGameArea.gameMatrix[i][j].value = Math.min(myGameArea.gameMatrix[i][j].value, 5-pass);
                                        }
                                    }
                                }
                                minX++;
                                maxX--;
                                minY++;
                                maxY--;
                            }
                        }
                    }
                }
            }




            /////////////////////////////////
            // used to detect keyboard button being pressed. Uses onkeydown() in body tag
            function keyPressed(event) {
                if (event.keyCode == 37) {
                    myGamePiece.moveLeft();
                    return true;
                } 
                else if (event.keyCode == 39) {
                    myGamePiece.moveRight();
                    return true;
                } 
                else if (event.keyCode == 38) {
                    myGamePiece.moveUp();
                    return true;
                } 
                else if (event.keyCode == 40) {
                    myGamePiece.moveDown();
                    return true;
                } 
                else if (event.keyCode == 66) {
                    myGamePiece.reveal();
                    return true;
                } 
                else {
                    return false;
                }
            }



            
            /////////////////////////////////////
            // sets position of game piece based on mouse click
            function doMouseDown(event) {
                // get position of mouse on screen
                canvasX = event.pageX;
                canvasY = event.pageY;
                //console.log("Debug: screen mouse position " + canvasX + " " + canvasY);

                //subtract canvas position from mouse position on screen
                var rect = myGameArea.canvas.getBoundingClientRect();
                canvasX = canvasX - rect.left;
                canvasY = canvasY - rect.top;
                // console.log("Debug: canvas mouse position " + canvasX + " " + canvasY);
                
                // draw new position rounded to the nearest gameSquareSize
                myGamePiece.x = parseInt(canvasX/gameSquareSize)*gameSquareSize;
                myGamePiece.y = parseInt(canvasY/gameSquareSize)*gameSquareSize;

                myGameArea.render();
            }



            ///////////////////////////////
            // sounds
            function playBombAudio(){
                document.getElementById("bombAudio").play();
            }


            // sleep function
            let sleep = milliseconds => {  
                return new Promise(resolve => setTimeout(resolve, milliseconds));  
            };  


            ////////////////////////////////////
            // images
            function bombImage(){
                const img = new Image();        
                img.src = './images/bomb.jpg';        
                img.onload = () => {          
                    myGameArea.context.drawImage(img, myGamePiece.x, myGamePiece.y);        
                };
                sleep(1000).then(() => {  
                    myGameArea.render();
                });  
            }



            ////////////////////////////////////////////
            // score
            var myScore = {
                gameScore : 0,
                
                // set score at start                
                start : function() {
                    document.getElementById("score").innerHTML = "Score: " + this.gameScore;
                },
                // update score by amount change
                update : function(change) {
                    this.gameScore = this.gameScore + change;
                    document.getElementById("score").innerHTML = "Score: " + this.gameScore;
                }
            }
            

        </script>
    </head>


    <body onload=" startGame()" onkeydown="return keyPressed(event)">

        <audio src="sounds/bomb.mp3" id="bombAudio"></audio>
   
        <div class="center" style="width:1000px">
            <h1>Paper submarine</h1>
            <div style="float:left; width:400px; background-color:#ffffff; padding:20px; height:600px; ";>
                <p id="score"></p>
                <p>Sink the enemy submarines without hitting innocent bystanders.</p>
                <p>Sonar numbers show how far a target is away from each shot.</p>

                <!-- The controls -->
                <p>Click buttons below or use the arrow keys to move the target.</p>
                <p>Scoring: </p>
                <ul>
                    <li>+1,000: Hitting an enemy submarine</li>
                    <li>-100: Hitting an innocent bystander</li>
                    <li>-10: Missing a shot with a torpedo</li>
                </ul>
                <button onClick="myGamePiece.moveUp();">MOVE UP</button><br>
                <button onClick="myGamePiece.moveLeft();">MOVE LEFT</button>
                <button onClick="myGamePiece.moveRight();">MOVE RIGHT</button><br>
                <button onClick="myGamePiece.moveDown();">MOVE DOWN</button><br>
                <button onClick="myGamePiece.reveal();">BOMB</button>
                <button onClick="myGameArea.reveal();">REVEAL</button>
                <button onClick="myGameArea.clear();">RESET</button>
            </div>
            <!-- The canvas where the game is drawn -->
            <div id="canvasDiv" style="float:left;"></div>
            
        </div>
    </body>
</html>




